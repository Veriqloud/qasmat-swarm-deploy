---
- name: Setup docker-swarm master
  hosts: proxy
  become: true
  roles:
  - role: install
  - role: docker_swarm_master

- name: Setup docker-swarm worker
  hosts:
  - storage
  - web
  - auth
  become: true
  roles:
  - role: install
  - role: docker_swarm_worker

- name: Add directories and permissions
  hosts: all
  become: true
  roles:
  - role: add_qasmatuser_dir

- name: Add secrets
  hosts: proxy
  become: true
  roles:
  - role: add_secrets

- name: Add qasmat config
  hosts:
  - proxy
  - storage
  become: true
  roles:
  - role: add_qasmat_config
  - role: docker_login_pull

- name: Add web config
  hosts: web
  become: true
  roles:
  - role: add_web_config

- name: Pull docker_images
  hosts:
  - proxy
  - storage
  - web
  become: true
  roles:
  - role: docker_login_pull

- name: Deploy the docker-swarm stack
  hosts: proxy
  become: true
  roles:
  - role: docker_swarm_deploy

- name: Configure Keycloak (conditional)
  hosts: keycloak
  become: true
  roles:
  - role: keycloak
    when: keycloak_dns is defined
